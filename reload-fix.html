<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Reload Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            line-height: 1.6;
            background: #f5f5f5;
        }
        .code-block {
            background: #333;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre;
            margin: 20px 0;
        }
        h2 {
            margin-top: 30px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .solution {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>Fix for Continuous Page Reloading</h1>
    
    <div class="solution">
        <strong>Quick Fix:</strong> Add the following code to prevent continuous page reloads. Copy this into a new file named <code>src/scripts/prevent-reload.js</code> and import it in your main layout or page.
    </div>

    <div class="code-block">// src/scripts/prevent-reload.js
console.log('Preventing automatic reloads...');

// Capture and block reload attempts
const originalReload = window.location.reload;
window.location.reload = function(forceGet) {
  console.warn('Page reload attempted - blocked to prevent refresh loop');
  // Only allow explicit user-triggered reloads
  if (document.visibilityState === 'visible' && event && event.isTrusted) {
    console.log('User-triggered reload allowed');
    return originalReload.apply(this, arguments);
  }
  return false;
};

// Also intercept history API usage that might cause reloads
const originalPushState = history.pushState;
history.pushState = function() {
  console.log('History pushState intercepted');
  const result = originalPushState.apply(this, arguments);
  return result;
};

// Check for meta refresh tags and remove them
document.addEventListener('DOMContentLoaded', () => {
  const metaTags = document.querySelectorAll('meta[http-equiv="refresh"]');
  if (metaTags.length > 0) {
    console.warn('Found meta refresh tags - removing:', metaTags.length);
    metaTags.forEach(tag => tag.remove());
  }

  // Look for the new.website script which might be causing issues
  const newWebsiteScript = document.querySelector('script[src*="new.website"]');
  if (newWebsiteScript) {
    console.warn('Found new.website script which may be causing reloads');
    // Optional: uncomment to disable the script
    // newWebsiteScript.setAttribute('data-disabled', 'true');
  }
});</div>

    <h2>Implementation Steps</h2>
    <ol>
        <li>Create a new file at <code>src/scripts/prevent-reload.js</code> with the code above</li>
        <li>Import the script in your main layout file by adding this line to the <code>BaseLayout.astro</code> file:</li>
    </ol>

    <div class="code-block">&lt;script&gt;
  import "../scripts/prevent-reload.js";
&lt;/script&gt;</div>

    <h2>Alternative Solutions</h2>
    <p>If the above doesn't work, try one of these approaches:</p>

    <ol>
        <li><strong>Comment out the new.website script</strong> in <code>index.astro</code>:
            <div class="code-block">&lt;!-- &lt;script src="https://api.new.website/static/new-website.js"&gt;&lt;/script&gt; --&gt;</div>
        </li>
        <li><strong>Create a Content Security Policy</strong> in <code>HeadSEO.astro</code>:
            <div class="code-block">&lt;meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; connect-src 'self';"&gt;</div>
        </li>
        <li><strong>Add a debounced reload handler</strong> that prevents multiple reloads in quick succession:
            <div class="code-block">let lastReloadTime = 0;
const RELOAD_THRESHOLD = 5000; // 5 seconds

window.addEventListener('beforeunload', (event) => {
  const now = Date.now();
  if (now - lastReloadTime < RELOAD_THRESHOLD) {
    event.preventDefault();
    event.returnValue = '';
    console.warn('Blocked rapid reload');
    return '';
  }
  lastReloadTime = now;
});</div>
        </li>
    </ol>
    
    <h2>Diagnosing the Issue</h2>
    <p>To help diagnose the exact cause of the reloads, add this debug script:</p>
    
    <div class="code-block">// Add this to a script tag in your layout file
let reloadCount = parseInt(sessionStorage.getItem('reloadCount') || '0');
reloadCount++;
sessionStorage.setItem('reloadCount', reloadCount.toString());
console.log(`Page load count: ${reloadCount}`);

// Log possible reload triggers
console.log('Reload triggers active:');
console.log('- Meta refresh:', document.querySelectorAll('meta[http-equiv="refresh"]').length > 0);
console.log('- new.website script:', document.querySelectorAll('script[src*="new.website"]').length > 0);
console.log('- Service worker:', 'serviceWorker' in navigator);

// Track performance
performance.mark('page-loaded');
setTimeout(() => {
  // Check if we're still on the page after 5 seconds
  performance.measure('page-stability', 'page-loaded');
  const measurement = performance.getEntriesByName('page-stability')[0];
  console.log(`Page stable for: ${measurement.duration}ms`);
}, 5000);</div>
</body>
</html>